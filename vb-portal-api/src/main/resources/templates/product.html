<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" th:content="'New Price! ' + ${offer.setName}">
    <meta property="og:description" th:content="'Price: €' + ${offer.price} + ' Ratio: ' + ${offer.partOutRatio}">
    <meta property="og:image" th:content="${offer.image}">
    <meta property="og:url" th:content="'/product?set=' + ${offer.setNumber}">
    <meta property="og:type" content="website">

    <th:block th:insert="~{fragments/product-common :: productStyles}"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .price-history-card {
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            padding: 8px;
        }

        .chart-wrapper {
            height: 260px;
            width: 100%;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .chart-wrapper {
                height: 200px;
            }
            .price-history-card {
                padding: 6px;
            }
            .page-header h2 {
                font-size: 18px;
            }
            .product-container {
                width: 100%;
            }
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            width: 100%;
            text-align: center;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 110;
            background: #f8f9fa;
        }

        .page-header-inner {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            gap: 10px;
        }

        .page-header .home-link {
            position: absolute;
            left: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 10px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            background: #f5f5f5;
            color: #333;
            text-decoration: none;
            gap: 4px;
        }

        .product-container {
            max-width: 800px;
            margin: auto;
            display: block;
            gap: 0;
        }

        .product-card {
            padding: 16px;
            margin-top: 20px;
        }

        /* Custom calculator */
        .custom-calc {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 12px;
            margin: 16px auto;
            max-width: 800px;
        }

        .custom-calc-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .custom-calc-header .material-icons {
            font-size: 20px;
        }

        .custom-calc .calc-body {
            margin-top: 10px;
            display: grid;
            gap: 10px;
        }

        .custom-calc .calc-input {
            width: 100%;
        }

        .custom-calc label {
            font-size: 13px;
            color: #555;
        }

        .custom-calc input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 17px;
            min-height: 44px;
            box-sizing: border-box;
        }

        .calc-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .calc-card {
            background: #f5f7fb;
            border-radius: 6px;
            padding: 10px;
        }

        .calc-card .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calc-card .value {
            font-size: 16px;
            font-weight: 700;
            color: #222;
        }

        .purchase-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 12px;
            margin: 16px auto;
            max-width: 800px;
        }

        .purchase-card h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 0 10px;
            font-size: 18px;
            font-weight: 600;
            color: #1976d2;
        }

        .purchase-form {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .purchase-form label {
            font-size: 13px;
            color: #555;
            display: block;
            margin-bottom: 4px;
        }

        .purchase-form input,
        .purchase-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 15px;
            box-sizing: border-box;
            min-height: 44px;
        }

        .purchase-actions {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        #purchase-submit {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            min-height: 44px;
        }

        #purchase-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #purchase-feedback {
            font-size: 13px;
            color: #2e7d32;
        }

        .store-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-top: 20px;
        }

        .store-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .store-item:last-child {
            border-bottom: none;
        }
        .store-info {
            display: flex;
            align-items: center;
        }

        .store-name {
            font-weight: bold;
        }

        .store-price {
            font-size: 16px;
            font-weight: bold;
            color: #1976d2;
        }

        .store-date {
            font-size: 12px;
            color: #666;
        }
    </style>
    <title>Product List</title>
</head>
<body>

<div class="page-header">
    <div class="page-header-inner">
        <a href="/" class="modern-link home-link">
            <span class="material-icons" style="font-size:18px;">home</span>
        </a>
        <div style="display:flex; align-items:center; gap:8px;">
            <span class="material-icons">local_mall</span>
            <h2 style="margin: 0;">Lego Set Details</h2>
        </div>
    </div>
</div>

<div class="product-container">
    <th:block th:insert="~{fragments/product-common :: productCard(${offer}, false)}"/>

    <div class="custom-calc" id="custom-calc"
         th:data-partout="${offer.partOutPrice}"
         th:data-pieces="${offer.pieces}">
        <div class="custom-calc-header">
            <span class="material-icons">calculate</span>
            Custom Price Calculator
        </div>
        <div class="calc-body">
            <div class="calc-input">
                <label for="custom-price">Enter custom price (€)</label>
                <input id="custom-price" name="custom-price" type="number" inputmode="decimal" min="0" step="0.01"
                       th:value="${offer.price}">
            </div>
            <div class="calc-results">
                <div class="calc-card">
                    <div class="label">Ratio</div>
                    <div class="value" id="calc-ratio">-</div>
                </div>
                <div class="calc-card">
                    <div class="label">Price / Piece</div>
                    <div class="value" id="calc-ppp">-</div>
                </div>
                <div class="calc-card">
                    <div class="label">Profit (€)</div>
                    <div class="value" id="calc-profit">-</div>
                </div>
            </div>
        </div>
    </div>

    <div class="store-list price-history-card" style="margin-top: 20px;" id="price-history-wrapper">
        <div style="display:flex; align-items:center; justify-content: space-between; gap:10px; flex-wrap: wrap;">
            <h3 style="margin:0;">Price History</h3>
            <div style="display:flex; align-items:center; gap:12px; flex-wrap: wrap; width:100%; max-width: 360px;">
                <label style="display:flex; align-items:center; gap:6px; font-size:14px; color:#555; flex:1 1 160px;">
                    Range:
                    <select id="price-range" style="padding:6px; border-radius:6px; border:1px solid #d0d7de;">
                        <option value="1m" selected>Last month</option>
                        <option value="3m">Last 3 months</option>
                        <option value="6m">Last 6 months</option>
                        <option value="all">All time</option>
                    </select>
                </label>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="price-history-chart"></canvas>
        </div>
    </div>

</div>

<th:block th:insert="~{fragments/product-common :: productScripts}"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script th:inline="javascript">
    function updateCustomCalculator() {
        const container = document.getElementById('custom-calc');
        if (!container) return;

        const input = document.getElementById('custom-price');
        const partOut = parseFloat(container.dataset.partout);
        const pieces = parseInt(container.dataset.pieces, 10);
        const price = parseFloat(input.value);

        const ratioEl = document.getElementById('calc-ratio');
        const pppEl = document.getElementById('calc-ppp');
        const profitEl = document.getElementById('calc-profit');

        const hasPrice = !Number.isNaN(price) && price > 0;
        const hasPartOut = !Number.isNaN(partOut) && partOut > 0;
        const hasPieces = !Number.isNaN(pieces) && pieces > 0;

        ratioEl.textContent = hasPrice && hasPartOut ? (partOut / price).toFixed(2) : 'N/A';
        pppEl.textContent = hasPrice && hasPieces ? (price / pieces).toFixed(3) : 'N/A';
        profitEl.textContent = hasPrice && hasPartOut ? (partOut - price).toFixed(2) : 'N/A';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('custom-price');
        if (input) {
            input.addEventListener('input', updateCustomCalculator);
            updateCustomCalculator();
        }

        const chartEl = document.getElementById('price-history-chart');
        if (chartEl) {
            /*<![CDATA[*/
            const rawData = /*[[${priceHistory}]]*/ [];
            /*]]>*/
            const parsedData = rawData.map(item => ({
                store: item.webStore || item.store,
                price: parseFloat(item.price),
                date: new Date(item.timestamp)
            })).filter(i => i.store && !Number.isNaN(i.price) && !Number.isNaN(i.date.getTime()));
            /*<![CDATA[*/
            const rawPurchases = /*[[${purchaseHistory}]]*/ [];
            /*]]>*/
            const parsedPurchases = rawPurchases.map(item => ({
                price: parseFloat(item.price),
                date: new Date(item.purchasedAt)
            })).filter(i => !Number.isNaN(i.price) && !Number.isNaN(i.date.getTime()));

            const rangeSelect = document.getElementById('price-range');
            const togglePurchases = document.getElementById('toggle-purchases');
            let chart;

            function filterData(range) {
                if (range === 'all') return parsedData;
                const now = new Date();
                const cutoff = new Date(now);
                if (range === '6m') {
                    cutoff.setMonth(now.getMonth() - 6);
                } else if (range === '3m') {
                    cutoff.setMonth(now.getMonth() - 3);
                } else {
                    cutoff.setMonth(now.getMonth() - 1);
                }
                return parsedData.filter(p => p.date >= cutoff);
            }

            function buildChartData(range) {
                const data = filterData(range);
                const grouped = data.reduce((acc, item) => {
                    if (!acc[item.store]) acc[item.store] = [];
                    acc[item.store].push({ x: item.date, y: item.price });
                    return acc;
                }, {});

                const colors = ['#1976d2','#2e7d32','#c62828','#f9a825','#6a1b9a','#00897b','#e65100','#5d4037','#00838f','#9c27b0','#ff7043','#7cb342','#ab47bc','#6d4c41','#546e7a','#ffb300','#7e57c2','#009688','#ef6c00','#8d6e63'];

                const datasets = Object.entries(grouped).map(([store, points], idx) => ({
                    label: store,
                    data: points.sort((a, b) => a.x - b.x),
                    borderColor: colors[idx % colors.length],
                    backgroundColor: colors[idx % colors.length],
                    tension: 0.2,
                    pointRadius: 2
                })).filter(ds => ds.data.length > 0);

                const purchasePoints = parsedPurchases;

                const pricePoints = datasets.flatMap(ds => ds.data);
                let minX = pricePoints.length ? pricePoints.reduce((min, p) => p.x < min ? p.x : min, pricePoints[0].x) : undefined;
                let maxX = pricePoints.length ? pricePoints.reduce((max, p) => p.x > max ? p.x : max, pricePoints[0].x) : undefined;

                if (purchasePoints.length > 0) {
                    const purchasePrices = Array.from(new Set(purchasePoints.map(p => p.price)));
                    if (!minX || !maxX) {
                        minX = purchasePoints.reduce((min, p) => p.date < min ? p.date : min, purchasePoints[0].date);
                        maxX = purchasePoints.reduce((max, p) => p.date > max ? p.date : max, purchasePoints[0].date);
                        if (minX.getTime() === maxX.getTime()) {
                            // avoid zero-length domain if purchases share same date
                            maxX = new Date(maxX.getTime() + 24 * 60 * 60 * 1000);
                        }
                    }
                    const domainMin = minX;
                    const domainMax = maxX;
                    purchasePrices.forEach((price, idx) => {
                        datasets.push({
                            label: purchasePrices.length > 1 ? `My purchase €${price}` : 'My purchase',
                            data: [
                                { x: domainMin, y: price },
                                { x: domainMax, y: price }
                            ],
                            borderColor: '#444',
                            borderDash: [6, 6],
                            borderWidth: 1,
                            pointRadius: 0,
                            fill: false,
                            tension: 0
                        });
                    });
                }

                const allPoints = datasets.flatMap(ds => ds.data);
                if (allPoints.length && (!minX || !maxX)) {
                    minX = allPoints.reduce((min, p) => p.x < min ? p.x : min, allPoints[0].x);
                    maxX = allPoints.reduce((max, p) => p.x > max ? p.x : max, allPoints[0].x);
                }

                return { datasets, minX, maxX };
            }

            function renderChart(range) {
                const { datasets, minX, maxX } = buildChartData(range);
                if (datasets.length === 0) {
                    chartEl.parentElement.innerHTML = '<p style="margin:0;color:#666;">No price history available.</p>';
                    return;
                }
                const isMobile = window.innerWidth < 640;
                if (chart) {
                    chart.data.datasets = datasets;
                    chart.options.scales.x.min = minX;
                    chart.options.scales.x.max = maxX;
                    chart.options.plugins.legend.display = !isMobile;
                    chart.update();
                    return;
                }
                chart = new Chart(chartEl, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        parsing: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { tooltipFormat: 'dd MMM yyyy', unit: 'day' },
                                title: { display: true, text: 'Date' },
                                min: minX,
                                max: maxX
                            },
                            y: { title: { display: true, text: 'Price' } }
                        },
                        plugins: {
                            legend: { position: 'bottom', display: !isMobile },
                            tooltip: { mode: 'nearest', intersect: false }
                        }
                    }
                });
            }

            if (rangeSelect) {
                rangeSelect.addEventListener('change', () => renderChart(rangeSelect.value));
            }
            window.addEventListener('resize', () => renderChart(rangeSelect ? rangeSelect.value : '1m'));
            renderChart(rangeSelect ? rangeSelect.value : '1m');
        }

    });
</script>
</body>
</html>
