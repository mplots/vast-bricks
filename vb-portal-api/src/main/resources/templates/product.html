<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Open Graph Meta Tags -->
    <meta property="og:title" th:content="'New Price! ' + ${offer.setName}">
    <meta property="og:description" th:content="'Price: €' + ${offer.price} + ' Ratio: ' + ${offer.partOutRatio}">
    <meta property="og:image" th:content="${offer.image}">
    <meta property="og:url" th:content="'/product?set=' + ${offer.setNumber}">
    <meta property="og:type" content="website">

    <th:block th:insert="~{fragments/product-common :: productStyles}"/>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0;
            width: 100%;
            text-align: center;
            padding: 12px 16px;
            position: sticky;
            top: 0;
            z-index: 110;
            background: #f8f9fa;
        }

        .product-container {
            max-width: 800px;
            margin: auto;
            display: block;
            gap: 0;
        }

        .product-card {
            padding: 16px;
            margin-top: 20px;
        }

        /* Custom calculator */
        .custom-calc {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 12px;
            margin: 16px auto;
            max-width: 800px;
        }

        .custom-calc-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 10px;
        }

        .custom-calc-header .material-icons {
            font-size: 20px;
        }

        .custom-calc .calc-body {
            margin-top: 10px;
            display: grid;
            gap: 10px;
        }

        .custom-calc .calc-input {
            width: 100%;
        }

        .custom-calc label {
            font-size: 13px;
            color: #555;
        }

        .custom-calc input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 17px;
            min-height: 44px;
            box-sizing: border-box;
        }

        .calc-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .calc-card {
            background: #f5f7fb;
            border-radius: 6px;
            padding: 10px;
        }

        .calc-card .label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calc-card .value {
            font-size: 16px;
            font-weight: 700;
            color: #222;
        }

        .purchase-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            padding: 12px;
            margin: 16px auto;
            max-width: 800px;
        }

        .purchase-card h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 0 10px;
            font-size: 18px;
            font-weight: 600;
            color: #1976d2;
        }

        .purchase-form {
            display: grid;
            gap: 10px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .purchase-form label {
            font-size: 13px;
            color: #555;
            display: block;
            margin-bottom: 4px;
        }

        .purchase-form input,
        .purchase-form select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d7de;
            border-radius: 6px;
            font-size: 15px;
            box-sizing: border-box;
            min-height: 44px;
        }

        .purchase-actions {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        #purchase-submit {
            background: #1976d2;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            min-height: 44px;
        }

        #purchase-submit:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #purchase-feedback {
            font-size: 13px;
            color: #2e7d32;
        }

        .store-list {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 16px;
            margin-top: 20px;
        }

        .store-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }

        .store-item:last-child {
            border-bottom: none;
        }
        .store-info {
            display: flex;
            align-items: center;
        }

        .store-name {
            font-weight: bold;
        }

        .store-price {
            font-size: 16px;
            font-weight: bold;
            color: #1976d2;
        }

        .store-date {
            font-size: 12px;
            color: #666;
        }
    </style>
    <title>Product List</title>
</head>
<body>

<div class="page-header">
    <span class="material-icons">local_mall</span>
    <h2 style="margin: 0;">Lego Set Details</h2>
</div>

<div class="product-container">
    <th:block th:insert="~{fragments/product-common :: productCard(${offer}, false)}"/>

    <div class="custom-calc" id="custom-calc"
         th:data-partout="${offer.partOutPrice}"
         th:data-pieces="${offer.pieces}">
        <div class="custom-calc-header">
            <span class="material-icons">calculate</span>
            Custom Price Calculator
        </div>
        <div class="calc-body">
            <div class="calc-input">
                <label for="custom-price">Enter custom price (€)</label>
                <input id="custom-price" name="custom-price" type="number" inputmode="decimal" min="0" step="0.01"
                       th:value="${offer.price}">
            </div>
            <div class="calc-results">
                <div class="calc-card">
                    <div class="label">Ratio</div>
                    <div class="value" id="calc-ratio">-</div>
                </div>
                <div class="calc-card">
                    <div class="label">Price / Piece</div>
                    <div class="value" id="calc-ppp">-</div>
                </div>
                <div class="calc-card">
                    <div class="label">Profit (€)</div>
                    <div class="value" id="calc-profit">-</div>
                </div>
            </div>
        </div>
    </div>

    <div class="purchase-card">
        <h3><span class="material-icons">add_shopping_cart</span>Record Purchase</h3>
        <form id="purchase-form" class="purchase-form" th:data-set-number="${offer.setNumber}">
            <div>
                <label for="purchase-store">Store</label>
                <select id="purchase-store" name="webStore" required>
                    <option th:each="price, priceStat : ${prices}"
                            th:value="${price.webStore}"
                            th:text="${price.webStore}"
                            th:data-price="${price.price}"
                            th:selected="${price.webStore == offer.webStore}"></option>
                </select>
            </div>
            <div>
                <label for="purchase-price">Price (€)</label>
                <input id="purchase-price" name="price" type="number" min="0" step="0.01" required
                       th:value="${offer.price}">
            </div>
            <div>
                <label for="purchase-qty">Quantity</label>
                <input id="purchase-qty" name="quantity" type="number" min="1" step="1" value="1">
            </div>
            <div>
                <label for="purchase-date">Date</label>
                <input id="purchase-date" name="purchasedAt" type="date"
                       th:value="${#dates.format(#dates.createNow(), 'yyyy-MM-dd')}">
            </div>
            <div class="purchase-actions">
                <button id="purchase-submit" type="submit">Add Purchase</button>
                <span id="purchase-feedback"></span>
            </div>
        </form>
    </div>

    <div class="store-list">
        <div th:each="price : ${prices}" class="store-item">
            <div class="store-info">
<!--                <img src="https://www.iizii.eu/image/catalog/1.png" alt="Store Logo" class="store-logo">-->
                <a class="modern-link" th:href="'/product?store=' + ${price.getWebStore()} + '&set=' + ${offer.getSetNumber()}"><span class="store-name" th:text="${price.getWebStore()}"/></a>

            </div>
            <div>
                <span class="store-price" th:text="'' + ${price.price}"/>
                <div class="store-date" th:text="${price.timestamp}"/>
            </div>
        </div>
    </div>

</div>

<th:block th:insert="~{fragments/product-common :: productScripts}"/>
<script>
    function updateCustomCalculator() {
        const container = document.getElementById('custom-calc');
        if (!container) return;

        const input = document.getElementById('custom-price');
        const partOut = parseFloat(container.dataset.partout);
        const pieces = parseInt(container.dataset.pieces, 10);
        const price = parseFloat(input.value);

        const ratioEl = document.getElementById('calc-ratio');
        const pppEl = document.getElementById('calc-ppp');
        const profitEl = document.getElementById('calc-profit');

        const hasPrice = !Number.isNaN(price) && price > 0;
        const hasPartOut = !Number.isNaN(partOut) && partOut > 0;
        const hasPieces = !Number.isNaN(pieces) && pieces > 0;

        ratioEl.textContent = hasPrice && hasPartOut ? (partOut / price).toFixed(2) : 'N/A';
        pppEl.textContent = hasPrice && hasPieces ? (price / pieces).toFixed(3) : 'N/A';
        profitEl.textContent = hasPrice && hasPartOut ? (partOut - price).toFixed(2) : 'N/A';
    }

    document.addEventListener('DOMContentLoaded', () => {
        const input = document.getElementById('custom-price');
        if (input) {
            input.addEventListener('input', updateCustomCalculator);
            updateCustomCalculator();
        }

        const purchaseForm = document.getElementById('purchase-form');
        const purchaseFeedback = document.getElementById('purchase-feedback');
        const purchaseSubmit = document.getElementById('purchase-submit');
        const storeSelect = document.getElementById('purchase-store');
        const priceInput = document.getElementById('purchase-price');

        if (storeSelect && priceInput) {
            const setPriceFromStore = () => {
                const selected = storeSelect.options[storeSelect.selectedIndex];
                const price = selected?.dataset?.price;
                if (price && !Number.isNaN(parseFloat(price))) {
                    priceInput.value = price;
                }
            };
            storeSelect.addEventListener('change', setPriceFromStore);
            setPriceFromStore();
        }

        if (purchaseForm) {
            purchaseForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                purchaseFeedback.textContent = '';

                const webStore = purchaseForm.webStore.value;
                const priceValue = parseFloat(purchaseForm.price.value);
                const quantityValue = parseInt(purchaseForm.quantity.value || '1', 10);
                const purchasedAtValue = purchaseForm.purchasedAt.value;
                const setNumber = purchaseForm.dataset.setNumber;

                if (!webStore) {
                    alert('Please select a store');
                    return;
                }
                if (Number.isNaN(priceValue) || priceValue <= 0) {
                    alert('Enter a valid price');
                    return;
                }
                if (Number.isNaN(quantityValue) || quantityValue <= 0) {
                    alert('Enter a valid quantity');
                    return;
                }

                const payload = {
                    price: priceValue,
                    quantity: quantityValue,
                    webStore: webStore
                };
                if (purchasedAtValue) {
                    payload.purchasedAt = purchasedAtValue;
                }

                purchaseSubmit.disabled = true;
                try {
                    const response = await fetch(`/api/brick-sets/${setNumber}/purchases`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        throw new Error(await response.text());
                    }
                    purchaseFeedback.textContent = 'Purchase saved! Updating...';
                    setTimeout(() => window.location.reload(), 400);
                } catch (err) {
                    alert('Failed to save purchase: ' + (err.message || 'Unknown error'));
                } finally {
                    purchaseSubmit.disabled = false;
                }
            });
        }
    });
</script>
</body>
</html>
